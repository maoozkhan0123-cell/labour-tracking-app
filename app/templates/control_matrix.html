<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Matrix - BabylonLLC</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>

<body>


    <!-- Sidebar (Shared navigation) -->
    <nav class="sidebar collapsed">
        <div class="brand">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <div class="brand-icon">
                    <img src="{{ url_for('static', filename='img/babylon.svg') }}" alt="Logo"
                        style="width: 20px; height: 20px; object-fit: contain;">
                </div>
                <span>BabylonLLC</span>
            </div>
            <button class="sidebar-toggle" onclick="toggleSidebar()">
                <i class="fa-solid fa-bars"></i>
            </button>
        </div>
        <ul class="nav-menu">
            <li><a href="{{ url_for('main.manager_dashboard') }}" class="nav-item">
                    <i class="fa-solid fa-border-all"></i> <span>Dashboard</span>
                </a></li>
            <li><a href="{{ url_for('main.control_matrix') }}" class="nav-item active">
                    <i class="fa-solid fa-table-cells"></i> <span>Control Matrix</span>
                </a></li>
            <li><a href="{{ url_for('main.control_table') }}" class="nav-item">
                    <i class="fa-solid fa-table-list"></i> <span>Control Table</span>
                </a></li>
            <li><a href="{{ url_for('main.manufacturing_orders') }}" class="nav-item">
                    <i class="fa-regular fa-clipboard"></i> <span>Manufacturing Orders</span>
                </a></li>
            <li><a href="{{ url_for('main.employee_activity') }}" class="nav-item">
                    <i class="fa-solid fa-users-viewfinder"></i> <span>Employee Activity</span>
                </a></li>
            <li><a href="{{ url_for('main.workers') }}" class="nav-item">
                    <i class="fa-regular fa-user"></i> <span>Workers</span>
                </a></li>
            <li><a href="{{ url_for('main.operations') }}" class="nav-item">
                    <i class="fa-solid fa-list-check"></i> <span>Operations</span>
                </a></li>
            <li><a href="{{ url_for('main.reports') }}" class="nav-item">
                    <i class="fa-solid fa-chart-column"></i> <span>Reports</span>
                </a></li>
        </ul>
        <div class="bottom-menu">
            <ul class="nav-menu">
                <li><a href="{{ url_for('main.logout') }}" class="nav-item"><i
                            class="fa-solid fa-arrow-right-from-bracket"></i> <span>Logout</span></a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content expanded">
        <div class="page-header" style="display:flex; justify-content:space-between; align-items:flex-end;">
            <div>
                <h1 class="page-title">Production Control Matrix</h1>
                <p class="page-subtitle">Click any cell to assign workers and control timers</p>
            </div>
            <button class="btn btn-secondary" onclick="openManualEntryModal()"
                style="width: auto; padding: 0.6rem 1.5rem;">
                <i class="fa-solid fa-plus"></i> Manual Entry
            </button>
        </div>

        <div class="matrix-container">
            <div class="matrix-grid">

                <!-- Header Row (Operations as Columns) -->
                <div class="matrix-row">
                    <div class="matrix-header-cell" style="text-align: left; padding-left: 20px;">
                        <span style="color: var(--text-muted); font-weight: 600;"><i
                                class="fa-regular fa-clipboard"></i> Manufacturing Orders</span>
                    </div>
                    {% for op in operations %}
                    <div class="matrix-header-cell">
                        <div style="font-weight:700; color:var(--text-main);">{{ op }}</div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Matrix Rows (MOs as Rows) -->
                {% for mo in mos %}
                <div class="matrix-row" id="mo-{{ mo.name }}">
                    <!-- Row Label (MO Info) -->
                    <div class="matrix-label-cell" style="width: 200px;">
                        <a href="{{ url_for('main.manufacturing_orders') }}" class="mo-badge"
                            style="text-decoration: none;">{{ mo.name }}</a>
                        <div class="mo-details" style="font-size:0.8rem;">{{ mo.product_id[1] }}</div>
                        <div style="margin-top:4px;">
                            <span class="status-badge badge-{{ mo.state }}">{{ mo.state }}</span>
                        </div>
                    </div>

                    <!-- Cells for each Operation -->
                    {% for op in operations %}

                    <!-- Determine cell state -->
                    {% set cell_tasks = [] %}
                    {% for t in tasks %}
                    {% if t.mo_reference == mo.name and t.description == op %}
                    {% set _ = cell_tasks.append(t) %}
                    {% endif %}
                    {% endfor %}

                    <!-- Check if any task has active timer using namespace -->
                    {% set ns = namespace(has_active=false) %}
                    {% for t in cell_tasks %}
                    {% if t.status == 'active' %}
                    {% set ns.has_active = true %}
                    {% endif %}
                    {% endfor %}

                    <div class="matrix-cell {% if cell_tasks %}active-cell{% endif %} {% if ns.has_active %}timer-running{% endif %}"
                        onclick="openAssign('{{ mo.name }}', '{{ op }}')">
                        {% if cell_tasks %}
                        <div style="display:flex; flex-direction:column; justify-content:space-between; height:100%;">
                            <div>
                                <div style="font-weight:700; color:var(--text-main); margin-bottom:4px;">
                                    <i class="fa-solid fa-user-group"
                                        style="color:var(--text-muted); margin-right:4px;"></i>
                                    {{ cell_tasks|length }} workers
                                </div>
                            </div>

                            <div style="display:flex; align-items:center; margin-top:8px;">
                                {% for t in cell_tasks[:3] %}
                                {% set worker = emp_map.get(t.assigned_to_id) %}
                                <a href="{{ url_for('main.employee_activity') }}" class="worker-avatar"
                                    title="{{ worker.name if worker else 'Unknown' }}" style="text-decoration: none;">
                                    {{ worker.name[0] if worker else '?' }}
                                </a>
                                {% endfor %}
                                {% if cell_tasks|length > 3 %}
                                <span class="worker-avatar" style="background:#CBD5E1; color:var(--text-muted);">+{{
                                    cell_tasks|length - 3 }}</span>
                                {% endif %}
                            </div>
                        </div>
                        {% else %}
                        <div class="matrix-cell-empty">
                            Click to assign
                        </div>
                        {% endif %}
                    </div>

                    {% endfor %}
                </div>
                {% endfor %}

            </div>
        </div>
    </main>

    <!-- Overlay (for closing offcanvas) -->
    <div id="overlay" class="overlay" onclick="closeAssign()"></div>

    <div id="assignSidebar" class="assign-modal"
        style="width: 600px; max-height: 85vh; position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%) scale(0.9); opacity: 0; pointer-events: none; background: #ffffff; border-radius: 24px; box-shadow: 0 20px 60px -10px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0,0,0,0.05); z-index: 2100; transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); display: flex; flex-direction: column; overflow: hidden;">

        <!-- Modal Header -->
        <div
            style="padding: 1.5rem 2rem; border-bottom: 1px solid #F1F5F9; background: #fff; display: flex; align-items: center; justify-content: space-between;">
            <div>
                <h2 id="headerProduct"
                    style="font-size: 1.25rem; color: #0F172A; font-weight: 700; margin-bottom: 0.25rem; letter-spacing: -0.02em;">
                    Product Name</h2>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span id="headerMO" class="badge badge-blue"
                        style="font-size: 0.7rem; padding: 0.25rem 0.6rem; border-radius: 6px;">MO-000</span>
                    <i class="fa-solid fa-chevron-right" style="color: #CBD5E1; font-size: 0.7rem;"></i>
                    <span id="headerOp" style="font-size: 0.8rem; font-weight: 600; color: #64748B;">Operation</span>
                </div>
            </div>
            <button class="close-btn" onclick="closeAssign()"
                style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: #F8FAFC; border: 1px solid #E2E8F0; color: #64748B; transition: all 0.2s; cursor: pointer;">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>

        <div class="offcanvas-body" style="padding: 2rem; background: #FCFCFD;">
            <!-- Assign Worker Section (Centered) -->
            <div style="margin-bottom: 2.5rem; text-align: center;">
                <h3 style="font-size: 0.9rem; font-weight: 700; color: #334155; margin-bottom: 1rem;">Assign Team Member
                </h3>
                <div
                    style="background: white; padding: 0.5rem; border-radius: 14px; border: 1px solid #E2E8F0; display: flex; align-items: center; width: 100%; max-width: 480px; margin: 0 auto; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);">
                    <div style="flex: 1; position: relative;" id="customSelectWrapper">
                        <!-- Custom Trigger -->
                        <div onclick="toggleCustomSelect()" id="customSelectTrigger"
                            style="width: 100%; height: 42px; padding: 0 1rem; border-radius: 10px; background: #F8FAFC; display: flex; align-items: center; justify-content: space-between; cursor: pointer; border: 1px solid transparent; transition: all 0.2s;">
                            <span id="customSelectValue"
                                style="font-size: 0.9rem; color: #64748B; font-weight: 500;">Select a worker...</span>
                            <i class="fa-solid fa-chevron-down" style="color: #64748B; font-size: 0.75rem;"></i>
                        </div>

                        <!-- Custom Options List -->
                        <div id="customOptions"
                            style="position: absolute; top: calc(100% + 8px); left: 0; width: 100%; background: white; border-radius: 12px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(0,0,0,0.05); z-index: 50; display: none; overflow: hidden; max-height: 240px; overflow-y: auto;">

                            <div class="custom-option" onclick="selectWorker('', 'Select a worker...', '0')"
                                style="padding: 10px 16px; border-bottom: 1px solid #F1F5F9; cursor: pointer; transition: background 0.15s;">
                                <div style="font-size: 0.9rem; font-weight: 500; color: #64748B;">Select a worker...
                                </div>
                            </div>

                            {% for emp in employees %}
                            <div class="custom-option"
                                onclick="selectWorker('{{ emp.id }}', '{{ emp.name }}', '{{ emp.hourly_rate }}')"
                                style="padding: 10px 16px; border-bottom: 1px solid #F1F5F9; cursor: pointer; transition: background 0.15s;">
                                <div style="font-size: 0.9rem; font-weight: 600; color: #1E293B;">{{ emp.name }}</div>
                                <div style="font-size: 0.75rem; color: #64748B; margin-top: 2px;">${{
                                    "%.2f"|format(emp.hourly_rate) }}/hr</div>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Hidden Select for Logic Compatibility -->
                        <select id="workerSelect" style="display: none;">
                            <option value="">Select a worker...</option>
                            {% for emp in employees %}
                            <option value="{{ emp.id }}" data-rate="{{ emp.hourly_rate }}">{{ emp.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="assignSingleWorker()"
                        style="width: auto !important; flex: 0 0 auto !important; padding: 0 1.5rem; height: 42px; border-radius: 10px; font-weight: 600; background: #4F46E5; color: white; border: none; font-size: 0.9rem; margin-left: 0.5rem; white-space: nowrap; box-shadow: 0 2px 5px rgba(79, 70, 229, 0.2);">
                        <i class="fa-solid fa-plus" style="margin-right: 4px;"></i> Assign
                    </button>
                </div>

                <style>
                    /* Custom Dropdown Hover Effects */
                    .custom-option:hover {
                        background: #F1F5F9 !important;
                    }

                    .custom-option:last-child {
                        border-bottom: none !important;
                    }

                    #customSelectTrigger:hover {
                        background: #F1F5F9 !important;
                    }
                </style>

                <script>
                    function toggleCustomSelect() {
                        const opts = document.getElementById('customOptions');
                        const isClosed = opts.style.display === 'none' || opts.style.display === '';
                        opts.style.display = isClosed ? 'block' : 'none';
                    }

                    function selectWorker(id, name, rate) {
                        // Update Hidden Select
                        const select = document.getElementById('workerSelect');
                        select.value = id;

                        // Update Trigger UI
                        const triggerText = document.getElementById('customSelectValue');
                        if (id) {
                            triggerText.innerHTML = `<span style="color:#0F172A; font-weight:600;">${name}</span> <span style="color:#64748B; font-weight:400; font-size:0.8rem; margin-left:4px;">($${parseFloat(rate).toFixed(2)}/hr)</span>`;
                            document.getElementById('customSelectTrigger').style.background = '#EEF2FF';
                            document.getElementById('customSelectTrigger').style.border = '1px solid #C7D2FE';
                        } else {
                            triggerText.innerText = 'Select a worker...';
                            triggerText.style.color = '#64748B';
                            document.getElementById('customSelectTrigger').style.background = '#F8FAFC';
                            document.getElementById('customSelectTrigger').style.border = '1px solid transparent';
                        }

                        // Close Dropdown
                        document.getElementById('customOptions').style.display = 'none';
                    }

                    // Close on click outside
                    document.addEventListener('click', function (e) {
                        const wrapper = document.getElementById('customSelectWrapper');
                        if (wrapper && !wrapper.contains(e.target)) {
                            document.getElementById('customOptions').style.display = 'none';
                        }
                    });
                </script>
            </div>

            <!-- Assigned Workers Section -->
            <div id="assignedSection">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #F1F5F9;">
                    <h3 id="assignedCountLabel"
                        style="font-size: 0.8rem; font-weight: 700; color: #94A3B8; text-transform: uppercase; letter-spacing: 0.05em;">
                        Assigned Workers (0)</h3>
                </div>

                <div id="assignedList" style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <!-- Placeholder when empty -->
                    <div id="noWorkersState"
                        style="padding: 3rem 1rem; text-align: center; border-radius: 16px; border: 2px dashed #E2E8F0; background: #F8FAFC;">
                        <div
                            style="width: 48px; height: 48px; background: #E0E7FF; color: #4F46E5; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; font-size: 1.25rem;">
                            <i class="fa-solid fa-user-plus"></i>
                        </div>
                        <h4 style="font-weight: 600; color: #1E293B; margin-bottom: 0.25rem;">No workers assigned</h4>
                        <p style="font-size: 0.9rem; color: #64748B;">Select a worker above to start tracking time.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Matrix specific refinements */
        .matrix-container {
            overflow-x: auto;
            background: white;
            border-radius: 16px;
            border: 1px solid var(--border);
            padding: 1rem;
        }

        .timer-badge {
            font-family: 'JetBrains Mono', 'Monaco', monospace;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }

        .worker-card {
            background: #fff;
            border: 1px solid #E2E8F0;
            border-radius: 16px;
            padding: 1rem;
            display: flex;
            align-items: center;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
            width: 100%;
        }

        .worker-card:hover {
            border-color: #818CF8;
            box-shadow: 0 10px 20px -5px rgba(99, 102, 241, 0.1);
            transform: translateY(-2px);
        }

        .avatar-lg {
            width: 52px;
            height: 52px;
            background: #4F46E5;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: 700;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
        }

        .status-pill {
            font-size: 0.65rem;
            font-weight: 800;
            padding: 5px 12px;
            border-radius: 6px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            white-space: nowrap;
        }

        .pill-running {
            background: #ECFDF5;
            color: #059669;
            border: 1px solid #D1FAE5;
        }

        .pill-paused {
            background: #FFFBEB;
            color: #D97706;
            border: 1px solid #FEF3C7;
        }

        .active-workers-pill {
            font-size: 0.7rem;
            font-weight: 800;
            padding: 4px 8px;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .active-workers-pill.active {
            background: #ECFDF5;
            color: #10B981;
            border: 1px solid #D1FAE5;
        }

        .active-workers-pill.unactive {
            background: #F8FAFC;
            color: #64748B;
            border: 1px solid #E2E8F0;
        }

        /* Action Toolbar Styles */
        .action-toolbar {
            display: flex;
            align-items: center;
            background: #F8FAFC;
            border: 1px solid #E2E8F0;
            border-radius: 12px;
            padding: 4px;
            gap: 4px;
        }

        .toolbar-btn {
            height: 36px;
            min-width: 36px;
            padding: 0 8px;
            /* flexible width for text buttons */
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: transparent;
            border-radius: 8px;
            color: #64748B;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .toolbar-btn:hover:not(:disabled) {
            background: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            color: #1E293B;
        }

        .toolbar-btn.btn-play {
            color: #4F46E5;
            background: #EEF2FF;
        }

        /* Blue for Clock In */
        .toolbar-btn.btn-play:hover {
            background: #E0E7FF;
        }

        .toolbar-btn.btn-pause {
            color: #D97706;
            background: #FEF3C7;
        }

        .toolbar-btn.btn-pause:hover {
            background: #FDE68A;
        }

        .toolbar-btn.btn-stop {
            color: #DC2626;
        }

        .toolbar-btn.btn-stop:hover {
            background: #FEF2F2;
        }

        .toolbar-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            color: #CBD5E1;
        }

        .pill-pending {
            background: #F1F5F9;
            color: #64748B;
            border: 1px solid #E2E8F0;
        }

        .offcanvas {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .offcanvas-body {
            overflow-y: auto;
            overflow-x: hidden;
            width: 100%;
        }
    </style>

    <!-- Manual Entry Modal -->
    <div id="manualEntryModal" class="offcanvas"
        style="right: auto; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 700px; height: auto; border-radius: 12px; opacity: 0; pointer-events: none; transition: opacity 0.2s; z-index: 1001;">
        <div class="offcanvas-header" style="margin-bottom: 1.5rem; padding: 2rem 2rem 1rem;">
            <h3 class="offcanvas-title" style="font-size: 1.25rem; font-weight: 700;">Manual Labor Entry</h3>
            <button class="close-btn" onclick="closeManualEntryModal()"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="offcanvas-body" style="padding:0 2rem 2rem;">
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #475569;">MO
                        Reference</label>
                    <select id="manual_mo"
                        style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border);">
                        <option value="">Select MO...</option>
                        {% for mo in mos %}
                        <option value="{{ mo.name }}">{{ mo.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label
                        style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #475569;">Operation</label>
                    <select id="manual_op"
                        style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border);">
                        <option value="">Select Operation...</option>
                        {% for op in operations %}
                        <option value="{{ op }}">{{ op }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label
                        style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #475569;">Worker</label>
                    <select id="manual_worker"
                        style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border);">
                        <option value="">Select Worker...</option>
                        {% for emp in employees %}
                        <option value="{{ emp.id }}">{{ emp.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 280px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #475569;">Start
                            Time</label>
                        <input type="datetime-local" id="manual_start"
                            style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border);">
                    </div>
                    <div style="flex: 1; min-width: 280px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #475569;">End
                            Time</label>
                        <input type="datetime-local" id="manual_end"
                            style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border);">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="submitManualEntry()"
                    style="margin-top: 1rem; width: 100%; padding: 0.75rem 0;">Submit Entry</button>
            </div>
        </div>
    </div>

    <!-- Pause Reason Modal (High Z-Index) -->
    <div id="pauseModal" class="custom-modal"
        style="width: 450px; padding: 0; border-radius: 16px; overflow: hidden; background: white; z-index: 2200; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9); opacity: 0; pointer-events: none; transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
        <div class="modal-header"
            style="padding: 1.5rem 2rem; border-bottom: none; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="font-size: 1.25rem; font-weight: 700; color: #111;">Pause Reason</h3>
            <button class="close-btn" onclick="closePauseModal()"
                style="background: none; border: none; font-size: 1.25rem; color: #666; cursor: pointer;"><i
                    class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="modal-body" style="padding: 0 2rem 2rem;">
            <p style="color: #64748B; font-size: 0.9rem; margin-bottom: 1rem;">Please specify why this worker is taking
                a break.</p>
            <div style="margin-bottom: 1.5rem;">
                <label
                    style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #111; font-size: 0.95rem;">Reason
                    (Required)</label>
                <input type="text" id="pause_reason_input" placeholder="e.g. Lunch Break, Meeting, Material Delay"
                    style="width: 100%; padding: 0.8rem 1rem; border-radius: 10px; border: 1.5px solid #DDD; font-size: 0.95rem; outline: none;">
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 0.75rem;">
                <button class="btn" onclick="closePauseModal()"
                    style="padding: 0.75rem 1.75rem; border-radius: 8px; border: 1.5px solid #DDD; background: white; color: #111; font-weight: 700; cursor: pointer;">Cancel</button>
                <button class="btn" id="confirmPauseBtn"
                    style="padding: 0.75rem 1.75rem; border-radius: 8px; border: none; background: #111; color: white; font-weight: 700; cursor: pointer;">Confirm
                    Pause</button>
            </div>
        </div>
    </div>
    <div id="modalOverlay" class="overlay" onclick="closeManualEntryModal()" style="z-index: 1000;"></div>

    <script>
        let currentMO = '';
        let currentOp = '';
        let currentProduct = '';
        let refreshInterval = null;

        const mosData = JSON.parse('{{ mos | tojson | safe }}');
        const allPendingTasks = JSON.parse('{{ tasks | tojson | safe }}');
        const employeeMap = JSON.parse('{{ emp_map | tojson | safe }}');

        function openAssign(moName, op) {
            currentMO = moName;
            currentOp = op;

            // Find product name
            const mo = mosData.find(m => m.name === moName);
            currentProduct = mo ? mo.product_id[1] : 'Unknown Product';

            // Update Header
            document.getElementById('headerMO').innerText = moName;
            document.getElementById('headerOp').innerText = op;
            document.getElementById('headerProduct').innerText = currentProduct;

            // Show Modal
            const modal = document.getElementById('assignSidebar');
            modal.style.opacity = '1';
            modal.style.pointerEvents = 'auto';
            modal.style.transform = 'translate(-50%, -50%) scale(1)';
            document.getElementById('overlay').classList.add('active');
            document.getElementById('overlay').style.zIndex = '2050';

            renderAssignedWorkers();

            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = setInterval(updateTimers, 1000);
        }

        function closeAssign() {
            const modal = document.getElementById('assignSidebar');
            modal.style.opacity = '0';
            modal.style.pointerEvents = 'none';
            modal.style.transform = 'translate(-50%, -50%) scale(0.9)';
            document.getElementById('overlay').classList.remove('active');
            if (refreshInterval) clearInterval(refreshInterval);
        }

        function renderAssignedWorkers() {
            const list = document.getElementById('assignedList');
            const placeholder = document.getElementById('noWorkersState');

            // Filter tasks for this specific cell
            const cellTasks = allPendingTasks.filter(t => t.mo_reference === currentMO && t.description === currentOp);

            list.innerHTML = '';
            document.getElementById('assignedCountLabel').innerText = `ASSIGNED WORKERS (${cellTasks.length})`;

            if (cellTasks.length === 0) {
                list.appendChild(placeholder);
                return;
            }

            cellTasks.forEach(task => {
                const card = document.createElement('div');
                card.className = 'worker-card';

                const worker = employeeMap[task.assigned_to_id] || { name: 'Unknown' };
                const initials = (worker.name || '?').substring(0, 1).toUpperCase();

                // Status Determination (Case insensitive)
                const statusStr = (task.status || 'pending').toLowerCase();
                const isPending = statusStr === 'pending';
                const isClockedOut = statusStr === 'clocked_out';
                const isClockedIn = statusStr === 'clocked_in';
                const isActive = statusStr === 'active';
                const isBreak = statusStr === 'break';

                let statusLabel = 'PENDING';
                let statusClass = 'pill-pending'; // gray
                if (isActive) { statusLabel = 'TIMER RUNNING'; statusClass = 'pill-running'; }
                else if (isClockedIn) { statusLabel = 'CLOCKED IN'; statusClass = 'pill-pending'; }
                else if (isBreak) { statusLabel = 'PAUSED'; statusClass = 'pill-paused'; }
                else if (isClockedOut) { statusLabel = 'CLOCKED OUT'; statusClass = 'pill-paused'; }

                // Toolbar Button Logic
                const showClockIn = isPending || isClockedOut;
                const showStart = isClockedIn;
                const showStop = isActive;
                const showClockOut = isClockedIn || isActive || isBreak;
                const showPause = isActive;
                const showResume = isBreak;

                let toolbarHtml = '';

                if (showClockIn) {
                    toolbarHtml += `
                        <button class="toolbar-btn btn-play" onclick="performTaskAction('${task.id}', 'clock_in')" title="Clock In">
                            <span style="font-weight:600; font-size:0.8rem; margin-left:2px;">Clock In</span> <i class="fa-solid fa-arrow-right-to-bracket" style="margin-left:6px;"></i>
                        </button>`;
                }

                if (showStart) {
                    toolbarHtml += `
                        <button class="toolbar-btn btn-play" onclick="performTaskAction('${task.id}', 'start')" title="Start Timer">
                            <span style="font-weight:600; font-size:0.8rem; margin-left:2px;">Start</span> <i class="fa-solid fa-play" style="margin-left:6px;"></i>
                        </button>`;
                }

                if (showStop) {
                    toolbarHtml += `
                        <button class="toolbar-btn btn-pause" onclick="performTaskAction('${task.id}', 'stop')" title="Stop Timer">
                            <span style="font-weight:600; font-size:0.8rem; margin-left:2px;">Stop</span> <i class="fa-solid fa-stop" style="margin-left:6px;"></i>
                        </button>`;
                }

                if (showResume) {
                    toolbarHtml += `
                        <button class="toolbar-btn btn-play" onclick="performTaskAction('${task.id}', 'resume')" title="Resume Work">
                            <span style="font-weight:600; font-size:0.8rem; margin-left:2px;">Resume</span> <i class="fa-solid fa-play" style="margin-left:6px;"></i>
                        </button>`;
                }

                if (showClockOut) {
                    toolbarHtml += `
                        <button class="toolbar-btn btn-pause" onclick="performTaskAction('${task.id}', 'clock_out')" title="Clock Out (End Shift)">
                             <span style="font-weight:600; font-size:0.8rem; margin-left:2px;">Clock Out</span> <i class="fa-solid fa-arrow-right-from-bracket" style="margin-left:6px;"></i>
                        </button>`;
                }

                if (showPause) {
                    toolbarHtml += `
                        <button class="toolbar-btn" onclick="taskAction('${task.id}', 'break')" title="Pause (Break)" style="color:#F59E0B;">
                            <i class="fa-solid fa-pause"></i>
                        </button>`;
                }

                // Stop Button (Finalize Task)
                const showComplete = !isPending;
                if (showComplete) {
                    toolbarHtml += `
                        <div style="width: 1px; height: 20px; background: #E2E8F0; margin: 0 4px;"></div>
                        <button class="toolbar-btn btn-stop" onclick="performTaskAction('${task.id}', 'complete')" title="Complete Task">
                            <i class="fa-solid fa-check"></i>
                        </button>`;
                }

                // Trash (Always)
                toolbarHtml += `
                        <button class="toolbar-btn" onclick="deleteTask('${task.id}')" title="Remove Assignment" style="margin-left:2px;">
                            <i class="fa-regular fa-trash-can"></i>
                        </button>`;


                card.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 1rem; width: 100%;">
                        <!-- Avatar -->
                        <div class="avatar-lg" style="width: 44px; height: 44px; font-size: 1rem; flex-shrink: 0; box-shadow: none; border: 2px solid white; background: var(--primary);">${initials}</div>
                        
                        <!-- Info -->
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 4px;">
                                <div style="font-weight: 700; color: #1E293B; font-size: 0.95rem;">${worker.name}</div>
                                <span class="status-pill ${statusClass}" style="font-size: 0.65rem; padding: 3px 8px;">
                                    ${statusLabel}
                                </span>
                            </div>
                            <div style="display:flex; align-items: center; gap: 1rem;">
                                <div style="font-size: 0.8rem; color: #64748B; font-weight: 500;">$${task.hourly_rate}/hr</div>
                                <div class="timer-badge" style="font-size: 1rem; color: #334155;" data-start="${task.last_action_time}" data-base="${task.active_seconds}" data-status="${task.status}">00:00:00</div>
                            </div>
                        </div>

                        <!-- Action Toolbar -->
                        <div class="action-toolbar" style="gap:2px; padding: 4px 8px;">
                            ${toolbarHtml}
                        </div>
                    </div>
                `;
                list.appendChild(card);
            });
            updateTimers();
        }

        function updateTimers() {
            const now = new Date();
            document.querySelectorAll('.timer-badge').forEach(badge => {
                const status = (badge.dataset.status || 'pending').toLowerCase();
                let totalSec = parseInt(badge.dataset.base) || 0;

                if (status === 'active') {
                    let startStr = badge.dataset.start;
                    if (startStr) {
                        // Robust parsing: "2023-01-01 12:00:00" -> "2023-01-01T12:00:00Z"
                        if (startStr.indexOf('T') === -1) startStr = startStr.replace(' ', 'T');
                        if (!startStr.endsWith('Z') && !startStr.includes('+')) startStr += 'Z';

                        const startTime = new Date(startStr);
                        if (!isNaN(startTime.getTime())) {
                            const diff = Math.floor((now - startTime) / 1000);
                            if (diff > 0) totalSec += diff;
                        } else {
                            console.warn('Invalid timer start date:', badge.dataset.start);
                        }
                    }
                }

                const hrs = Math.floor(totalSec / 3600).toString().padStart(2, '0');
                const mins = Math.floor((totalSec % 3600) / 60).toString().padStart(2, '0');
                const secs = (totalSec % 60).toString().padStart(2, '0');
                badge.innerText = `${hrs}:${mins}:${secs}`;
            });
        }

        async function assignSingleWorker() {
            const select = document.getElementById('workerSelect');
            const empId = select.value;
            if (!empId) return alert('Select a worker first');

            const option = select.options[select.selectedIndex];
            const rate = option.dataset.rate;
            const empName = option.text;

            try {
                const res = await fetch('/api/assign_task', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        assignments: [{ employee_id: empId, hourly_rate: rate }],
                        description: currentOp,
                        mo_reference: currentMO
                    })
                });

                if (res.ok) {
                    const data = await res.json();

                    // Optimistic / Instant Update
                    // We can use the tasks returned by backend if available, or create local one
                    if (data.new_tasks && data.new_tasks.length > 0) {
                        allPendingTasks.push(...data.new_tasks);
                    } else {
                        // Fallback: reload all
                        const tasksRes = await fetch('/api/tasks');
                        if (tasksRes.ok) {
                            const d = await tasksRes.json();
                            allPendingTasks.length = 0;
                            allPendingTasks.push(...d.tasks);
                        }
                    }

                    renderAssignedWorkers();
                    // Reset the select
                    selectWorker('', 'Select a worker...', '0');
                }
            } catch (e) { console.error(e); }
        }

        let currentActionTaskId = null;
        async function taskAction(taskId, action) {
            if (action === 'break') {
                currentActionTaskId = taskId;
                openPauseModal();
                return;
            }

            performTaskAction(taskId, action);
        }

        function openPauseModal() {
            document.getElementById('pause_reason_input').value = ''; // Clear previous input
            const modal = document.getElementById('pauseModal');
            modal.style.opacity = '1';
            modal.style.pointerEvents = 'auto';
            modal.style.transform = 'translate(-50%, -50%) scale(1)';

            // Ensure overlay is above sidebar
            document.getElementById('overlay').classList.add('active');
            document.getElementById('overlay').style.zIndex = '2150'; // Between sidebar (2100) and pause modal (2200)
        }

        function closePauseModal() {
            const modal = document.getElementById('pauseModal');
            modal.style.opacity = '0';
            modal.style.pointerEvents = 'none';
            modal.style.transform = 'translate(-50%, -50%) scale(0.9)';

            // Only remove overlay active if sidebar is NOT active. 
            // Actually sidebar uses overlay too. We need to be careful not to close sidebar overlay if sidebar is open.
            // But here we're using a single overlay #overlay. 
            // If we close pause modal, and assignment sidebar is open, overlay should remain.
            // Let's check if sidebar is active.
            const sidebar = document.getElementById('assignSidebar');
            if (sidebar.style.opacity !== '1') {
                document.getElementById('overlay').classList.remove('active');
            } else {
                // Ensure overlay z-index returns to sidebar level
                document.getElementById('overlay').style.zIndex = '2050';
            }
            currentActionTaskId = null;
        }

        document.getElementById('confirmPauseBtn').onclick = () => {
            const reason = document.getElementById('pause_reason_input').value;
            if (!reason) return alert('Reason is required');
            performTaskAction(currentActionTaskId, 'break', reason);
            // Modal close is handled by page reload in performTaskAction success
        };

        async function performTaskAction(taskId, action, reason = null) {
            let body = { action: action };
            if (reason) body.reason = reason;

            try {
                const res = await fetch(`/api/task/${taskId}/action`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (res.ok) {
                    // Close pause modal if it was open
                    if (action === 'break') {
                        closePauseModal();
                    }
                    // Fetch updated tasks and re-render
                    const tasksRes = await fetch('/api/tasks');
                    if (tasksRes.ok) {
                        const data = await tasksRes.json();
                        allPendingTasks.length = 0;
                        allPendingTasks.push(...data.tasks);
                        renderAssignedWorkers();

                        // Update matrix cell colors dynamically
                        updateMatrixCellColors(data.tasks);
                    }
                } else {
                    const err = await res.json();
                    alert('Error: ' + (err.error || 'Failed to perform action'));
                }
            } catch (e) {
                console.error(e);
                alert('Connection error. Please try again.');
            }
        }

        function updateMatrixCellColors(tasks) {
            // Group tasks by MO and Operation
            const cellMap = {};
            tasks.forEach(task => {
                const key = `${task.mo_reference}|||${task.description}`;
                if (!cellMap[key]) cellMap[key] = [];
                cellMap[key].push(task);
            });

            // Update each cell's class
            document.querySelectorAll('.matrix-cell').forEach(cell => {
                const moName = cell.getAttribute('onclick')?.match(/'([^']+)'/)?.[1];
                const opName = cell.getAttribute('onclick')?.match(/'([^']+)',\s*'([^']+)'/)?.[2];

                if (moName && opName) {
                    const key = `${moName}|||${opName}`;
                    const cellTasks = cellMap[key] || [];
                    const hasActive = cellTasks.some(t => t.status === 'active');

                    // Update classes
                    if (hasActive) {
                        cell.classList.add('timer-running');
                    } else {
                        cell.classList.remove('timer-running');
                    }
                }
            });
        }

        async function deleteTask(taskId) {
            if (!confirm('Are you sure you want to remove this task assignment?')) return;

            try {
                const res = await fetch(`/api/task/${taskId}/cancel`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (res.ok) {
                    // Fetch updated tasks and re-render
                    const tasksRes = await fetch('/api/tasks');
                    if (tasksRes.ok) {
                        const data = await tasksRes.json();
                        allPendingTasks.length = 0;
                        allPendingTasks.push(...data.tasks);
                        renderAssignedWorkers();
                    }
                } else {
                    alert('Error removing task');
                }
            } catch (e) { console.error(e); }
        }

        // Manual Entry Logic
        function openManualEntryModal() {
            document.getElementById('manualEntryModal').style.opacity = '1';
            document.getElementById('manualEntryModal').style.pointerEvents = 'all';
            document.getElementById('modalOverlay').classList.add('active');
        }

        function closeManualEntryModal() {
            document.getElementById('manualEntryModal').style.opacity = '0';
            document.getElementById('manualEntryModal').style.pointerEvents = 'none';
            document.getElementById('modalOverlay').classList.remove('active');
        }

        async function submitManualEntry() {
            const mo = document.getElementById('manual_mo').value;
            const op = document.getElementById('manual_op').value;
            const worker = document.getElementById('manual_worker').value;
            const start = document.getElementById('manual_start').value;
            const end = document.getElementById('manual_end').value;

            if (!mo || !op || !worker || !start || !end) return alert('Please fill all fields');

            try {
                const res = await fetch('/api/manual_entry', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        mo_reference: mo,
                        operation: op,
                        employee_id: worker,
                        start_time: start,
                        end_time: end
                    })
                });
                if (res.ok) location.reload();
                else alert('Error submitting entry');
            } catch (e) { console.error(e); }
        }

        // Scroll to MO if hash exists
        window.onload = () => {
            if (window.location.hash) {
                const el = document.querySelector(window.location.hash);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth' });
                    el.style.background = '#FEFCE8';
                    setTimeout(() => el.style.background = '', 3000);
                }
            }
        };

        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            const toggleIcon = document.querySelector('.sidebar-toggle i');

            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');

            if (sidebar.classList.contains('collapsed')) {
                toggleIcon.classList.remove('fa-xmark');
                toggleIcon.classList.add('fa-bars');
            } else {
                toggleIcon.classList.remove('fa-bars');
                toggleIcon.classList.add('fa-xmark');
            }
        }
    </script>
</body>

</html>