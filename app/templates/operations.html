<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operations - BabylonLLC</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>

<body>


    <!-- Sidebar -->
    <nav class="sidebar collapsed">
        <div class="brand">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <div class="brand-icon">
                    <img src="{{ url_for('static', filename='img/babylon.svg') }}" alt="Logo"
                        style="width: 20px; height: 20px; object-fit: contain;">
                </div>
                <span>BabylonLLC</span>
            </div>
            <button class="sidebar-toggle" onclick="toggleSidebar()">
                <i class="fa-solid fa-bars"></i>
            </button>
        </div>
        <ul class="nav-menu">
            <li><a href="{{ url_for('main.manager_dashboard') }}" class="nav-item">
                    <i class="fa-solid fa-border-all"></i> <span>Dashboard</span>
                </a></li>
            <li><a href="{{ url_for('main.control_matrix') }}" class="nav-item">
                    <i class="fa-solid fa-table-cells"></i> <span>Control Matrix</span>
                </a></li>
            <li><a href="{{ url_for('main.control_table') }}" class="nav-item">
                    <i class="fa-solid fa-table-list"></i> <span>Control Table</span>
                </a></li>
            <li><a href="{{ url_for('main.manufacturing_orders') }}" class="nav-item">
                    <i class="fa-regular fa-clipboard"></i> <span>Manufacturing Orders</span>
                </a></li>
            <li><a href="{{ url_for('main.employee_activity') }}" class="nav-item">
                    <i class="fa-solid fa-users-viewfinder"></i> <span>Employee Activity</span>
                </a></li>
            <li><a href="{{ url_for('main.workers') }}" class="nav-item">
                    <i class="fa-regular fa-user"></i> <span>Workers</span>
                </a></li>
            <li><a href="{{ url_for('main.operations') }}" class="nav-item active">
                    <i class="fa-solid fa-list-check"></i> <span>Operations</span>
                </a></li>
            <li><a href="{{ url_for('main.reports') }}" class="nav-item">
                    <i class="fa-solid fa-chart-column"></i> <span>Reports</span>
                </a></li>
        </ul>
        <div class="bottom-menu">
            <ul class="nav-menu">
                <li><a href="#" class="nav-item">
                        <i class="fa-solid fa-gear"></i> <span>Settings</span>
                    </a></li>
                <li><a href="{{ url_for('main.logout') }}" class="nav-item">
                        <i class="fa-solid fa-arrow-right-from-bracket"></i> <span>Logout</span>
                    </a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content expanded">
        <div class="page-header" style="display:flex; justify-content:space-between; align-items:flex-end;">
            <div>
                <h1 class="page-title">Operations</h1>
                <p class="page-subtitle">Global operations used across all manufacturing orders</p>
            </div>
            <button class="btn btn-primary" onclick="openAddModal()" style="width: auto; padding: 0.6rem 1.5rem;">
                <i class="fa-solid fa-plus" style="margin-right:8px;"></i> Add Operation
            </button>
        </div>

        <div class="table-container" id="operations-list" style="padding: 0.5rem 0;">

            {% for op in operations %}
            <div class="operation-item" draggable="true" data-id="{{ op.id }}"
                style="display: flex; align-items: center; justify-content: space-between; padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); background: white; transition: all 0.2s;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <i class="fa-solid fa-grip-vertical" style="color: #D1D5DB; cursor: grab;"></i>
                    <div
                        style="width: 32px; height: 32px; background: #EEF2FF; color: var(--primary); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: 600;">
                        {{ loop.index }}
                    </div>
                    <div>
                        <div style="font-weight: 700; color: var(--text-main);">{{ op.name }}</div>
                        <div style="font-size: 0.9rem; color: var(--text-muted);">{{ op.desc }}</div>
                    </div>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="icon-btn" title="Edit"
                        onclick="openEditModal('{{ op.id }}', '{{ op.name }}', '{{ op.desc }}')"><i
                            class="fa-solid fa-pen"></i></button>
                    <button class="icon-btn delete" title="Delete" onclick="deleteOperation('{{ op.id }}')"><i
                            class="fa-regular fa-trash-can"></i></button>
                </div>
            </div>
            {% endfor %}

        </div>
    </main>

    <!-- Add Operation Modal -->
    <div id="addModal" class="offcanvas"
        style="right: auto; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 500px; height: auto; border-radius: 12px; opacity: 0; pointer-events: none; transition: opacity 0.2s;">
        <div class="offcanvas-header" style="margin-bottom: 1.5rem;">
            <h3 class="offcanvas-title">Add Operation</h3>
            <button class="close-btn" onclick="closeAddModal()"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="offcanvas-body" style="padding-bottom: 0;">
            <div class="form-group">
                <label
                    style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-main);">Operation
                    Name</label>
                <input type="text" id="op_name" placeholder="e.g., Receiving, Packing"
                    style="width: 100%; border: 1px solid var(--border); border-radius: 8px; padding: 0.7rem;">
            </div>
            <div class="form-group" style="margin-top: 1rem;">
                <label
                    style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-main);">Description
                    (optional)</label>
                <textarea id="op_desc" rows="3" placeholder="Brief description of the operation"
                    style="width: 100%; border: 1px solid var(--border); border-radius: 8px; padding: 0.7rem; font-family: inherit;"></textarea>
            </div>
        </div>
        <div class="selection-footer"
            style="margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 0.75rem; padding: 0 2rem 2rem;">
            <button class="btn" style="background: white; border: 1px solid var(--border); color: var(--text-main);"
                onclick="closeAddModal()">Cancel</button>
            <button class="btn btn-primary" onclick="createOperation()">Create</button>
        </div>
    </div>
    <div id="modalOverlay" class="overlay" onclick="closeAddModal(); closeEditModal();"></div>

    <!-- Edit Operation Modal -->
    <div id="editModal" class="offcanvas"
        style="right: auto; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 500px; height: auto; border-radius: 12px; opacity: 0; pointer-events: none; transition: opacity 0.2s; z-index: 1001;">
        <div class="offcanvas-header" style="margin-bottom: 1.5rem; padding: 2rem 2rem 0.5rem;">
            <h3 class="offcanvas-title">Edit Operation</h3>
            <button class="close-btn" onclick="closeEditModal()"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="offcanvas-body" style="padding: 0 2rem 1.5rem;">
            <input type="hidden" id="edit_op_id">
            <div class="form-group">
                <label
                    style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-main);">Operation
                    Name</label>
                <input type="text" id="edit_op_name"
                    style="width: 100%; border: 1px solid var(--border); border-radius: 8px; padding: 0.7rem;">
            </div>
            <div class="form-group" style="margin-top: 1rem;">
                <label
                    style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-main);">Description</label>
                <textarea id="edit_op_desc" rows="3"
                    style="width: 100%; border: 1px solid var(--border); border-radius: 8px; padding: 0.7rem; font-family: inherit;"></textarea>
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 1.5rem;">
                <button class="btn" onclick="closeEditModal()">Cancel</button>
                <button class="btn btn-primary" onclick="updateOperation()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Custom Delete Confirmation Modal -->
    <div id="deleteModal" class="custom-modal">
        <div class="modal-header">
            <h3>Delete Operation</h3>
        </div>
        <div class="modal-body">
            Are you sure you want to delete this operation? This may affect existing assignments and historic data.
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
            <button class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
        </div>
    </div>

    <script>
        let operationToDelete = null;

        function openAddModal() {
            document.getElementById('addModal').style.opacity = '1';
            document.getElementById('addModal').style.pointerEvents = 'all';
            document.getElementById('modalOverlay').classList.add('active');
        }

        function closeAddModal() {
            document.getElementById('addModal').style.opacity = '0';
            document.getElementById('addModal').style.pointerEvents = 'none';
            document.getElementById('modalOverlay').classList.remove('active');
        }

        async function createOperation() {
            const name = document.getElementById('op_name').value;
            const desc = document.getElementById('op_desc').value;
            if (!name) return alert('Name is required');

            try {
                const res = await fetch('/api/operations/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, desc })
                });
                if (res.ok) location.reload();
            } catch (e) { console.error(e); }
        }

        function openEditModal(id, name, desc) {
            document.getElementById('edit_op_id').value = id;
            document.getElementById('edit_op_name').value = name;
            document.getElementById('edit_op_desc').value = desc;

            document.getElementById('editModal').style.opacity = '1';
            document.getElementById('editModal').style.pointerEvents = 'all';
            document.getElementById('modalOverlay').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').style.opacity = '0';
            document.getElementById('editModal').style.pointerEvents = 'none';
            document.getElementById('modalOverlay').classList.remove('active');
        }

        async function updateOperation() {
            const id = document.getElementById('edit_op_id').value;
            const name = document.getElementById('edit_op_name').value;
            const desc = document.getElementById('edit_op_desc').value;

            try {
                const res = await fetch('/api/operations/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, name, desc })
                });
                if (res.ok) location.reload();
            } catch (e) { console.error(e); }
        }

        function deleteOperation(id) {
            operationToDelete = id;
            document.getElementById('deleteModal').classList.add('active');
            document.getElementById('modalOverlay').classList.add('active');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
            document.getElementById('modalOverlay').classList.remove('active');
            operationToDelete = null;
        }

        document.getElementById('confirmDeleteBtn').onclick = async () => {
            if (!operationToDelete) return;
            try {
                const res = await fetch('/api/operations/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: operationToDelete })
                });
                if (res.ok) location.reload();
            } catch (e) { console.error(e); }
        };
    </script>
    <style>
        .operation-item.dragging {
            opacity: 0.5;
            background: #F9FAFB !important;
            border: 2px dashed #CBD5E1 !important;
        }
    </style>
    <script>
        // Drag and Drop Logic
        const container = document.getElementById('operations-list');
        let draggables = [];

        function initDragAndDrop() {
            draggables = document.querySelectorAll('.operation-item');

            draggables.forEach(draggable => {
                draggable.addEventListener('dragstart', () => {
                    draggable.classList.add('dragging');
                });

                draggable.addEventListener('dragend', () => {
                    draggable.classList.remove('dragging');
                    saveOrder();
                });
            });
        }

        // Initialize on load
        initDragAndDrop();

        container.addEventListener('dragover', e => {
            e.preventDefault();
            const afterElement = getDragAfterElement(container, e.clientY);
            const draggable = document.querySelector('.dragging');
            if (afterElement == null) {
                container.appendChild(draggable);
            } else {
                container.insertBefore(draggable, afterElement);
            }
        });

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.operation-item:not(.dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        async function saveOrder() {
            const items = [...document.querySelectorAll('.operation-item')];
            const ids = items.map(item => item.dataset.id);

            try {
                await fetch('/api/operations/reorder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids: ids })
                });
            } catch (e) {
                console.error('Failed to save order', e);
            }
        }
    </script>
    <script>
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            const toggleIcon = document.querySelector('.sidebar-toggle i');

            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');

            if (sidebar.classList.contains('collapsed')) {
                toggleIcon.classList.remove('fa-xmark');
                toggleIcon.classList.add('fa-bars');
            } else {
                toggleIcon.classList.remove('fa-bars');
                toggleIcon.classList.add('fa-xmark');
            }
        }
    </script>
</body>

</html>