<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Portal - Babylon Labor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
</head>

<body style="background: #f8f9fa;">
    {% macro format_seconds(s) -%}
    {% set hours = (s // 3600) %}
    {% set minutes = (s % 3600) // 60 %}
    {% set seconds = s % 60 %}
    {{ "%02d:%02d:%02d"|format(hours, minutes, seconds) }}
    {%- endmacro %}

    <header>
        <h1>BABYLON PORTAL</h1>
        <div style="display: flex; gap: 1rem; align-items: center;">
            <span style="font-weight: 600;">{{ current_user.name }}</span>
            <a href="{{ url_for('main.logout') }}"
                style="color: var(--babylon-gold); text-decoration: none; font-weight: 800; font-size: 0.9rem;">LOGOUT</a>
        </div>
    </header>

    <div class="dashboard" style="display: block; max-width: 850px; margin: 0 auto; padding: 2rem 1rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h2
                style="font-size: 1.1rem; text-transform: uppercase; letter-spacing: 1px; color: var(--babylon-navy); margin: 0; border-left: 4px solid var(--babylon-gold); padding-left: 15px;">
                Assigned Workflows</h2>
            <div style="font-size: 0.8rem; color: #7f8c8d; font-weight: 600;">{{ tasks|length }} ASSIGNMENTS</div>
        </div>

        {% for task in tasks if task.status != 'cancelled' %}
        <div class="mo-card {{ task.status }}"
            style="margin-bottom: 2rem; padding: 0; border-radius: 20px; overflow: hidden; border: 1px solid var(--babylon-border); background: white; transition: all 0.3s ease; box-shadow: 0 10px 30px rgba(0,0,0,0.03);"
            id="task-{{ task.id }}" data-id="{{ task.id }}" data-status="{{ task.status }}" {% if task.status=='active'
            and task.last_action_time %} data-last-action="{{ task.last_action_time.isoformat() }}"
            data-base-seconds="{{ task.active_seconds }}" {% elif task.status=='break' and task.last_action_time %}
            data-last-break-start="{{ task.last_action_time.isoformat() }}"
            data-base-break-seconds="{{ task.break_seconds }}" {% endif %}>

            <div
                style="padding: 1.5rem 2rem; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; background: {% if task.status == 'active' %}#fffbeb{% elif task.status == 'break' %}#fef2f2{% else %}#fff{% endif %};">
                <div>
                    <span class="status-badge" style="position: static; margin-bottom: 8px;">{{ task.status }}</span>
                    <h3 style="font-size: 1.4rem; color: var(--babylon-navy); margin: 0;">{{ task.description }}</h3>
                    <div style="font-size: 0.85rem; color: #7f8c8d; margin-top: 4px;">MO Reference: <strong
                            style="color: var(--babylon-navy);">{{ task.mo_reference }}</strong></div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 0.7rem; font-weight: 800; color: #7f8c8d; text-transform: uppercase;">Hourly
                        Rate</div>
                    <div style="font-size: 1.2rem; font-weight: 800; color: var(--babylon-navy);">${{
                        "%.2f"|format(task.hourly_rate) }}<span style="font-size: 0.8rem; opacity: 0.5;">/hr</span>
                    </div>
                </div>
            </div>

            <div
                style="padding: 2rem; display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; text-align: center;">
                <div style="padding: 1rem; background: #f0fdf4; border-radius: 15px;">
                    <div
                        style="font-size: 0.7rem; font-weight: 800; color: #16a34a; text-transform: uppercase; margin-bottom: 5px;">
                        Active Work</div>
                    <div class="live-active-timer"
                        style="font-size: 1.8rem; font-family: 'Poppins'; font-weight: 800; color: var(--babylon-navy);">
                        {{ format_seconds(task.active_seconds) }}
                    </div>
                </div>
                <div style="padding: 1rem; background: #fff1f2; border-radius: 15px;">
                    <div
                        style="font-size: 0.7rem; font-weight: 800; color: #e11d48; text-transform: uppercase; margin-bottom: 5px;">
                        Break Time</div>
                    <div class="live-break-timer"
                        style="font-size: 1.8rem; font-family: 'Poppins'; font-weight: 800; color: #7f8c8d;">
                        {{ format_seconds(task.break_seconds) }}
                    </div>
                </div>
                <div style="padding: 1rem; background: #fffbeb; border-radius: 15px; border: 1px solid #fef3c7;">
                    <div
                        style="font-size: 0.7rem; font-weight: 800; color: var(--babylon-gold); text-transform: uppercase; margin-bottom: 5px;">
                        Est. Earnings</div>
                    <div class="live-earned-amount" data-rate="{{ task.hourly_rate }}"
                        style="font-size: 1.8rem; font-family: 'Poppins'; font-weight: 800; color: var(--babylon-navy);">
                        ${{ "%.2f"|format(task.amount_earned) }}
                    </div>
                </div>
            </div>

            <div style="padding: 0 2rem 2rem; display: flex; gap: 1rem;">
                {% if task.status == 'pending' %}
                <button class="btn btn-primary" style="flex: 1; padding: 1.2rem; font-size: 1rem;"
                    onclick="taskAction('{{ task.id }}', 'start')">START WORKFLOW</button>
                {% elif task.status == 'active' %}
                <button class="btn btn-primary" style="flex: 2; padding: 1.2rem; font-size: 1rem;"
                    onclick="taskAction('{{ task.id }}', 'complete')">✓ COMPLETE WORKFLOW</button>
                <button class="btn btn-danger" style="flex: 1; padding: 1.2rem; font-size: 1rem; background: #dc2626;"
                    onclick="showBreakModal('{{ task.id }}')">PAUSE / BREAK</button>
                {% elif task.status == 'break' %}
                <button class="btn btn-primary"
                    style="flex: 1; padding: 1.2rem; font-size: 1rem; background: var(--babylon-gold); border-color: var(--babylon-gold);"
                    onclick="taskAction('{{ task.id }}', 'resume')">RESUME WORKFLOW</button>
                {% elif task.status == 'completed' %}
                <div
                    style="flex: 1; background: #ecfdf5; color: #065f46; padding: 1.2rem; border-radius: 99px; font-weight: 800; text-align: center; border: 1px solid #10b981;">
                    ✓ WORKFLOW FINALIZED & SAVED
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Break Reason Modal -->
    <div class="overlay" id="break-overlay">
        <div class="timer-modal glass-panel">
            <h2 style="color: var(--babylon-navy); font-size: 1.2rem; text-transform: uppercase;">Stop Reason</h2>
            <div class="form-group" style="text-align: left;">
                <label>Why are you stopping the workflow?</label>
                <input type="text" id="break-reason" placeholder="e.g. Machine Maintenance, Shift End..."
                    style="width: 100%;">
            </div>
            <button class="btn btn-primary" id="confirm-break-btn">SUBMIT & STOP</button>
            <button class="btn btn-danger" style="margin-top: 1rem;" onclick="hideBreakModal()">CANCEL</button>
        </div>
    </div>

    <script>
        function format_hhmmss(s) {
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            const sec = s % 60;
            return [h, m, sec].map(v => v.toString().padStart(2, '0')).join(':');
        }

        function updateLiveTimers() {
            // Update Active Timers
            document.querySelectorAll('.mo-card[data-status="active"]').forEach(card => {
                const lastAction = new Date(card.dataset.lastAction + 'Z');
                const baseSeconds = parseInt(card.dataset.baseSeconds || 0);
                const elapsed = Math.floor((new Date() - lastAction) / 1000);
                const totalActive = baseSeconds + elapsed;

                const activeDisplay = card.querySelector('.live-active-timer');
                if (activeDisplay) activeDisplay.innerText = format_hhmmss(totalActive);

                // Update Earned Amount Live
                const earnedDisplay = card.querySelector('.live-earned-amount');
                if (earnedDisplay) {
                    const rate = parseFloat(earnedDisplay.dataset.rate);
                    const currentEarned = (totalActive / 3600) * rate;
                    earnedDisplay.innerText = '$' + currentEarned.toFixed(2);
                }
            });

            // Update Break Timers (Non-Active)
            document.querySelectorAll('.mo-card[data-status="break"]').forEach(card => {
                const breakStart = new Date(card.dataset.lastBreakStart + 'Z');
                const baseBreakSec = parseInt(card.dataset.baseBreakSeconds || 0);
                const elapsed = Math.floor((new Date() - breakStart) / 1000);
                const breakDisplay = card.querySelector('.live-break-timer');
                if (breakDisplay) breakDisplay.innerText = format_hhmmss(baseBreakSec + elapsed);
            });
        }

        setInterval(updateLiveTimers, 1000);

        async function taskAction(taskId, action, reason = '') {
            const res = await fetch(`/api/task/${taskId}/action`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, reason })
            });
            if (res.ok) {
                location.reload();
            } else {
                alert("Failed to update process. Please try again.");
            }
        }

        let activeBreakTaskId = null;
        function showBreakModal(taskId) {
            activeBreakTaskId = taskId;
            document.getElementById('break-overlay').classList.add('active');
        }

        function hideBreakModal() {
            document.getElementById('break-overlay').classList.remove('active');
        }

        document.getElementById('confirm-break-btn').onclick = () => {
            const reason = document.getElementById('break-reason').value;
            if (!reason) return alert("Please provide a reason");
            taskAction(activeBreakTaskId, 'break', reason);
        };
    </script>
</body>

</html>