<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - BabylonLLC</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>

<body>


    <!-- Sidebar -->
    <nav class="sidebar collapsed">
        <div class="brand">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <div class="brand-icon">
                    <img src="{{ url_for('static', filename='img/babylon.svg') }}" alt="Logo"
                        style="width: 20px; height: 20px; object-fit: contain;">
                </div>
                <span>BabylonLLC</span>
            </div>
            <button class="sidebar-toggle" onclick="toggleSidebar()">
                <i class="fa-solid fa-bars"></i>
            </button>
        </div>
        <ul class="nav-menu">
            <li><a href="{{ url_for('main.manager_dashboard') }}" class="nav-item">
                    <i class="fa-solid fa-border-all"></i> <span>Dashboard</span>
                </a></li>
            <li><a href="{{ url_for('main.control_matrix') }}" class="nav-item">
                    <i class="fa-solid fa-table-cells"></i> <span>Control Matrix</span>
                </a></li>
            <li><a href="{{ url_for('main.manufacturing_orders') }}" class="nav-item">
                    <i class="fa-regular fa-clipboard"></i> <span>Manufacturing Orders</span>
                </a></li>
            <li><a href="{{ url_for('main.employee_activity') }}" class="nav-item">
                    <i class="fa-solid fa-users-viewfinder"></i> <span>Employee Activity</span>
                </a></li>
            <li><a href="{{ url_for('main.workers') }}" class="nav-item">
                    <i class="fa-regular fa-user"></i> <span>Workers</span>
                </a></li>
            <li><a href="{{ url_for('main.operations') }}" class="nav-item">
                    <i class="fa-solid fa-list-check"></i> <span>Operations</span>
                </a></li>
            <li><a href="{{ url_for('main.reports') }}" class="nav-item active">
                    <i class="fa-solid fa-chart-column"></i> <span>Reports</span>
                </a></li>
        </ul>
        <div class="bottom-menu">
            <ul class="nav-menu">
                <li><a href="#" class="nav-item">
                        <i class="fa-solid fa-gear"></i> <span>Settings</span>
                    </a></li>
                <li><a href="{{ url_for('main.logout') }}" class="nav-item">
                        <i class="fa-solid fa-arrow-right-from-bracket"></i> <span>Logout</span>
                    </a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content expanded">
        <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-end;">
            <div>
                <h1 class="page-title">Reports</h1>
                <p class="page-subtitle">Labor cost and time analysis</p>
            </div>
            <div style="display: flex; gap: 0.75rem;">
                <!-- <button class="btn btn-secondary" onclick="window.print()"><i class="fa-solid fa-print"></i> Print</button> -->
                <button class="btn btn-primary"
                    onclick="window.location.href='/api/reports/export_csv' + window.location.search"><i
                        class="fa-solid fa-file-export"></i> Export CSV</button>
            </div>
        </div>

        <div class="reports-filter-card">
            <div
                style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; color: var(--text-main); font-weight: 700;">
                <i class="fa-solid fa-filter" style="color: var(--primary);"></i> Filters
            </div>
            <form id="filterForm" class="filter-grid" method="GET">
                <div class="filter-group">
                    <label>Worker</label>
                    <select name="employee" class="form-select"
                        style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: #F8FAFC;">
                        <option value="all">All Workers</option>
                        {% for emp in employees %}
                        <option value="{{ emp.id }}" {% if filters.employee==emp.id %}selected{% endif %}>{{ emp.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <label>Manufacturing Order</label>
                    <select name="mo" class="form-select"
                        style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: #F8FAFC;">
                        <option value="all">All Orders</option>
                        {% for mo in mos %}
                        <option value="{{ mo.id }}" {% if filters.mo==mo.id %}selected{% endif %}>{{ mo.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <label>Operation</label>
                    <select name="operation" class="form-select"
                        style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: #F8FAFC;">
                        <option value="all">All Operations</option>
                        {% for op in operations %}
                        <option value="{{ op.name }}" {% if filters.operation==op.name %}selected{% endif %}>{{ op.name
                            }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <label>Start Date</label>
                    <input type="date" name="start_date" value="{{ filters.start }}"
                        style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: #F8FAFC;">
                </div>
                <div class="filter-group">
                    <label>End Date</label>
                    <input type="date" name="end_date" value="{{ filters.end }}"
                        style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: #F8FAFC;">
                </div>
            </form>
            <div style="display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 1.5rem;">
                <button class="btn btn-secondary" onclick="window.location.href='/reports'"><i
                        class="fa-solid fa-rotate-left"></i> Reset</button>
                <button class="btn btn-primary" onclick="document.getElementById('filterForm').submit()">Apply
                    Filters</button>
            </div>
        </div>

        <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 2rem;">
            <div class="report-stat-card">
                <div>
                    <div class="stat-label">Total Hours (Unique)</div>
                    <div class="stat-value">{{ total_hours }}</div>
                    <div class="stat-detail">{{ tasks|length }} time entries</div>
                </div>
                <div class="icon-box icon-blue"><i class="fa-regular fa-clock"></i></div>
            </div>
            <div class="report-stat-card">
                <div>
                    <div class="stat-label">Labor Cost</div>
                    <div class="stat-value">${{ total_cost }}</div>
                    <div class="stat-detail">Based on hourly rates</div>
                </div>
                <div class="icon-box icon-green"><i class="fa-solid fa-dollar-sign"></i></div>
            </div>
            <div class="report-stat-card">
                <div>
                    <div class="stat-label">Avg Cost/Hour</div>
                    <div class="stat-value">${{ avg_rate }}</div>
                    <div class="stat-detail">Blended rate</div>
                </div>
                <div class="icon-box icon-yellow"><i class="fa-solid fa-chart-line"></i></div>
            </div>
        </div>

        <div class="content-grid" style="margin-bottom: 2rem;">
            <div class="section-card">
                <div class="section-header">
                    <h2 class="section-title"><i class="fa-solid fa-users" style="margin-right: 8px;"></i> Hours by
                        Worker</h2>
                </div>
                <div style="height: 300px;">
                    <canvas id="workerChart"></canvas>
                </div>
            </div>
            <div class="section-card">
                <div class="section-header">
                    <h2 class="section-title"><i class="fa-solid fa-list-check" style="margin-right: 8px;"></i> Hours by
                        Operation</h2>
                </div>
                <div style="height: 300px; display: flex; align-items: center; justify-content: center;">
                    <canvas id="opChart"></canvas>
                </div>
            </div>
        </div>

        <div class="section-card">
            <div class="section-header">
                <h2 class="section-title"><i class="fa-regular fa-clock" style="margin-right: 8px;"></i> Time Entry
                    Details</h2>
            </div>
            <div class="table-container">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #F8FAFC; border-bottom: 1px solid var(--border);">
                            <th style="padding: 1rem; text-align: left; font-weight: 600;">Worker</th>
                            <th style="padding: 1rem; text-align: left; font-weight: 600;">Order</th>
                            <th style="padding: 1rem; text-align: left; font-weight: 600;">Operation</th>
                            <th style="padding: 1rem; text-align: left; font-weight: 600;">Start Time</th>
                            <th style="padding: 1rem; text-align: left; font-weight: 600;">Duration</th>
                            <th style="padding: 1rem; text-align: left; font-weight: 600;">Type</th>
                            <th style="padding: 1rem; text-align: left; font-weight: 600;">Cost</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for task in tasks %}
                        <tr style="border-bottom: 1px solid var(--border);">
                            <td style="padding: 1rem; font-weight: 700;">{{ task.employee_name }}</td>
                            <td style="padding: 1rem; color: var(--primary); font-weight: 600;">{{ task.mo_reference }}
                            </td>
                            <td style="padding: 1rem;">{{ task.description }}</td>
                            <td style="padding: 1rem; color: var(--text-muted);">
                                {{ (task.start_time[:16].replace('T', ', ')) if task.start_time else 'N/A' }}
                            </td>
                            <td style="padding: 1rem;">{{ (task.active_seconds // 3600) if task.active_seconds else 0
                                }}h {{ (task.active_seconds % 3600 // 60) if task.active_seconds else 0 }}m</td>
                            <td style="padding: 1rem;">
                                <span class="badge"
                                    style="background: #EEF2FF; color: #4F46E5; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">{{
                                    'manual' if task.manual else 'auto' }}</span>
                            </td>
                            <td style="padding: 1rem; font-weight: 700;">${{ "%.2f"|format(task.cost or 0) }}</td>
                        </tr>
                        {% endfor %}
                        {% if not tasks %}
                        <tr>
                            <td colspan="7" style="padding: 2rem; text-align: center; color: var(--text-muted);">No
                                entries found for the selected filters.</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Worker Chart
        const workerLabels = JSON.parse('{{ hours_by_worker.keys() | list | tojson | safe }}');
        const workerData = JSON.parse('{{ hours_by_worker.values() | list | tojson | safe }}');

        new Chart(document.getElementById('workerChart'), {
            type: 'bar',
            data: {
                labels: workerLabels,
                datasets: [{
                    label: 'Productive Hours',
                    data: workerData,
                    backgroundColor: '#6366F1',
                    borderRadius: 8,
                    maxBarThickness: 40
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y', // Horizontal bars
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { borderDash: [5, 5] }, ticks: { font: { weight: '600' } } },
                    y: { grid: { display: false }, ticks: { font: { weight: '600' } } }
                }
            }
        });

        // Operation Chart
        const opLabels = JSON.parse('{{ hours_by_op.keys() | list | tojson | safe }}');
        const opData = JSON.parse('{{ hours_by_op.values() | list | tojson | safe }}');

        new Chart(document.getElementById('opChart'), {
            type: 'doughnut',
            data: {
                labels: opLabels,
                datasets: [{
                    data: opData,
                    backgroundColor: ['#6366F1', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899'],
                    borderWidth: 0,
                    weight: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { usePointStyle: true, font: { weight: '600' } } }
                },
                cutout: '70%'
            }
        });
    </script>
    <script>
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            const toggleIcon = document.querySelector('.sidebar-toggle i');

            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');

            if (sidebar.classList.contains('collapsed')) {
                toggleIcon.classList.remove('fa-xmark');
                toggleIcon.classList.add('fa-bars');
            } else {
                toggleIcon.classList.remove('fa-bars');
                toggleIcon.classList.add('fa-xmark');
            }
        }
    </script>
</body>

</html>